package com.malware.application.cache;

import org.infinispan.manager.EmbeddedCacheManager;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * This class wraps the Infinispan API for a mapping between TID, SID, and ProcessInstanceId
 */
@Service("id-mapping-cache")
public class IdMappingCache {

    private static final String CACHE_NAME = "processIdCache";
    private final EmbeddedCacheManager cacheManager;

    @Autowired
    public IdMappingCache(EmbeddedCacheManager cacheManager) {
        this.cacheManager = cacheManager;
    }

    /**
     * Publish a process id mapping to the cache
     * @param processId the process instance id
     * @param sId the submission ID
     * @param tId the transaction ID
     */
    public void publishKeymap(long processId, String tId, String sId) {
        ProcessIdMapping mapping = new ProcessIdMapping( processId, tId, sId );
        cacheManager.getCache(CACHE_NAME).put(mapping.getProcessInstanceId(), mapping);
    }

    /**
     * Load a process id mapping
     * @param processInstanceId the process instance ID to load
     * @return the relevant process instance ID or {@code null} if it does not exist in the cache
     */
    public ProcessIdMapping getMappedValues(long processInstanceId) {
        return (ProcessIdMapping) cacheManager.getCache(CACHE_NAME).getOrDefault(processInstanceId, null);
    }

    /**
     * Delete a process instance ID from the cache
     * @param processInstanceId the process instance ID
     * @return {@code true} if an item was removed, otherwise {@code false}
     */
    public boolean deleteProcessMapping(long processInstanceId) {
        System.out.println("id = " + processInstanceId );

        // This is not removing from the persistent store for some reason. TODO: Investigate
        Object o = cacheManager.getCache(CACHE_NAME).remove(processInstanceId);
        return o != null;
    }

}
